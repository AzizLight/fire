<?php

define('ENVIRONMENT', 'development');
switch (ENVIRONMENT)
{
    case 'development':
        error_reporting(-1);
        ini_set('display_errors', 1);
    break;

    case 'production':
        error_reporting(0);
    break;

    default:
        exit('The application environment is not set correctly.');
}

define('BASE_PATH', __DIR__);

require_once "config/constants.php";
require_once "helpers/application_helpers.php";

// Load all the classes dynamically
foreach (glob(BASE_PATH . "/classes/*.php") as $php_class)
{
    require_once $php_class;
}

// Load the base command since every command extend it
require_once BASE_PATH . "/classes/commands/base_command.php";

// Lazy-load the commands
function __autoload($command)
{
    require_once BASE_PATH . '/classes/commands/' . ApplicationHelpers::underscorify($command) . '.php';
}

try
{
    $message = Inferno::init($argv);
    if ($message)
    {
        // TODO: add a feedback message to tell the user that the file was generated successfully
        echo $message;
    }
    exit;
}
catch (InvalidArgumentException $e)
{
    if ($e->getCode() == INVALID_TASK_EXCEPTION)
    {
        // TODO: create more help files.
        fwrite(STDOUT, Inferno::help("main"));
        exit;
    }
    elseif ($e->getCode() == INVALID_SUBJECT_EXCEPTION)
    {
        fwrite(STDOUT, Inferno::help("main"));
        exit;
    }
    elseif ($e->getCode() == MISSING_NAME_EXCEPTION)
    {
        fwrite(STDOUT, 'Please enter a name:' . PHP_EOL);
        $name = trim(fgets(STDIN));
        if (empty($name))
        {
            fwrite(STDOUT, 'The name is required!' . PHP_EOL);
            exit;
        }
        else
        {
            // retry to run the script.
            Inferno::init(array_merge($argv, array($name)));
            exit;
        }
    }
    else
    {
        //FIXME: Handle this better!
        fwrite(STDOUT, $e->getMessage() . PHP_EOL);
        exit;
    }
}
catch (RuntimeException $e)
{
    //FIXME: Handle this better!
    fwrite(STDOUT, $e->getMessage() . PHP_EOL);
    exit;
}

/* End of file fire.php */
